<html ng-app="fiddleApp">
<head>
    <title>Angular Fiddle</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css">
    <style>.ace_editor {
        height: 400px;
        max-width: 100%;
    }

    input {
        width: 500px;
    }

    iframe{
        width: 100%;
        height: 350px;
    }
    </style>
</head>
<body ng-controller="MainCtrl">
<p>
    <button ng-click="gistId=8972289">Primitives</button>
    <button ng-click="gistId=8973753">Strings</button>
    <button ng-click="gistId=8975840">Booleans</button>
    <button ng-click="gistId=8976378">Functions</button>
    <button ng-click="gistId=8977139">Variable References</button>
    <button ng-click="gistId=8976835">Variable Names</button>
    <button ng-click="gistId=8978574">Scopes</button>
</p>
<p><input type="text" ng-model="gistId" placeholder="ID of your Gist">
    <button ng-click="fetch()">Fetch</button>
    <button ng-click="execute()">Execute</button>
</p>

<div class="row">
    <div class="col-xs-12">
        <tabset>
            <tab ng-repeat="file in files">
                <tab-heading ng-bind="file.filename.toLowerCase()"></tab-heading>
                <div ui-ace="{ mode: file.language.toLowerCase()}" ng-model="file.content"></div>
            </tab>
        </tabset>
    </div>
</div>

<iframe id="result"></iframe>

<script type="text/javascript" src="bower_components/ace-builds/src-min-noconflict/ace.js"></script>
<script type="text/javascript" src="bower_components/angular/angular.js"></script>
<script type="text/javascript" src="bower_components/angular-ui-ace/ui-ace.js"></script>
<script type="text/javascript" src="bower_components/angular-bootstrap/ui-bootstrap.js"></script>
<script type="text/javascript" src="bower_components/angular-bootstrap/ui-bootstrap-tpls.js"></script>
<script>
    var myAppModule = angular.module('fiddleApp', ['ui.ace', 'ui.bootstrap']);

    function MainCtrl($scope, $http) {
        // https://api.github.com/gists/8961251

        $scope.fetch = function(){
            $http.get("https://api.github.com/gists/"+$scope.gistId)
            //$http.get("data.json")
                    .then(function (res) {
                //$scope.gist_url = res.data.html_url
                $scope.files = res.data.files;

            });
        };
        // TODO: Remove
        $scope.fetch();

        $scope.execute = function () {
            var currentIframe = document.getElementById('result'),
                    currentParentNode = currentIframe.parentNode;
            currentIframe.parentNode.removeChild(currentIframe);

            var iframe = document.createElement("iframe");
            iframe.id = "result";
            currentParentNode.appendChild(iframe);



            if (iframe.contentDocument) doc = iframe.contentDocument;
            else if (iframe.contentWindow) doc = iframe.contentWindow.document;
            else doc = iframe.document;


            var index = $scope.files['index.html'];
            if (!index) {
                throw "No index.html defined";
            }

            var indexhtml = index.content;
            var Regex = /<script[^>]+src=\"([\w/\\.]*)\"*[^>]*>/g;
            var results = [],
                    match;
            while (match = Regex.exec(indexhtml)) {
                results.push(match);
            }



            angular.forEach(results, function (result) {
                var scriptTag = result[0];
                var fileName = result[1];

                if ($scope.files[fileName]) {
                    var replaceTag = "<script>" + $scope.files[fileName].content;
                    indexhtml = indexhtml.replace(scriptTag, replaceTag);
                }

            });



            doc.open();
            doc.writeln(indexhtml);
            doc.close();
        };


    }
</script>

</body>
</html>