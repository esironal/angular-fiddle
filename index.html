<html ng-app="fiddleApp">
<head>
    <title>ngFiddle</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body ng-controller="MainCtrl">

<nav class="navbar navbar-inverse">
  <a class="navbar-brand" href="#">ngFiddle</a>
  <ul class="nav navbar-nav">
    <li ng-class="{active: gistId==8972289}"><a href ng-click="gistId=8972289;fetch()">Primitives</a></li>
    <li ng-class="{active: gistId==8973753}"><a href ng-click="gistId=8973753;fetch()" ng-class="active: gistId==">Strings</a></li>
    <li ng-class="{active: gistId==8975840}"><a href ng-click="gistId=8975840;fetch()" ng-class="active: gistId==">Booleans</a></li>
    <li ng-class="{active: gistId==8976378}"><a href ng-click="gistId=8976378;fetch()" ng-class="active: gistId==">Functions</a></li>
    <li ng-class="{active: gistId==8977139}"><a href ng-click="gistId=8977139;fetch()" ng-class="active: gistId==">Variable References</a></li>
    <li ng-class="{active: gistId==8976835}"><a href ng-click="gistId=8976835;fetch()" ng-class="active: gistId==">Variable Names</a></li>
    <li ng-class="{active: gistId==8978574}"><a href ng-click="gistId=8978574;fetch()" ng-class="active: gistId==">Scopes</a></li>
  </ul>
  <form class="navbar-form navbar-right">
    <div class="form-group">
      <input type="text" class="form-control" ng-model="gistId" placeholder="ID of your Gist">
    </div>
    <button type="submit" class="btn btn-default" ng-click="fetch()">Load!</button>
  </form>
</nav>

<div class="editor-wrapper row">
    <div class="col-xs-12">
        <tabset>
            <tab ng-repeat="file in files">
                <tab-heading ng-bind="file.filename.toLowerCase()"></tab-heading>
                <div ui-ace="{ mode: file.language.toLowerCase(), onLoad: aceLoaded}" ng-model="file.content"></div>
            </tab>
        </tabset>
    </div>
</div>

<div class="execute-wrapper">
    <button class="btn btn-info form-control" ng-click="execute()">Run! (Cmd+Enter)</button>
</div>

<div class="result-wrapper">
  <iframe id="result"></iframe>
</div>

<script type="text/javascript" src="bower_components/ace-builds/src-min-noconflict/ace.js"></script>
<script type="text/javascript" src="bower_components/angular/angular.js"></script>
<script type="text/javascript" src="bower_components/angular-ui-ace/ui-ace.js"></script>
<script type="text/javascript" src="bower_components/angular-bootstrap/ui-bootstrap.js"></script>
<script type="text/javascript" src="bower_components/angular-bootstrap/ui-bootstrap-tpls.js"></script>
<script>
    var myAppModule = angular.module('fiddleApp', ['ui.ace', 'ui.bootstrap']);

    function MainCtrl($scope, $http) {
        $scope.aceLoaded = function(editor) {
          editor.setOptions({ maxLines: Infinity });
          editor.commands.addCommand({
              name: "showKeyboardShortcuts",
              bindKey: {win: "Ctrl-Enter", mac: "Command-Enter"},
              exec: function(editor) { $scope.execute(); }
          })
        };

        $scope.fetch = function(){
            $http.get("https://api.github.com/gists/"+$scope.gistId)
            //$http.get("data.json")
                .then(function (res) {
                   $scope.files = res.data.files;
                });
        };
        // TODO: Remove
        $scope.fetch();

        $scope.execute = function () {
            var currentIframe = document.getElementById('result'),
                    currentParentNode = currentIframe.parentNode;
            currentIframe.parentNode.removeChild(currentIframe);

            var iframe = document.createElement("iframe");
            iframe.id = "result";
            currentParentNode.appendChild(iframe);

            if (iframe.contentDocument) doc = iframe.contentDocument;
            else if (iframe.contentWindow) doc = iframe.contentWindow.document;
            else doc = iframe.document;


            var index = $scope.files['index.html'];
            if (!index) {
                throw "No index.html defined";
            }

            var indexhtml = index.content;
            var Regex = /<script[^>]+src=\"([\w\/\\.]*)\"*[^>]*>/g;
            var results = [],

            match;
            while (match = Regex.exec(indexhtml)) {
                results.push(match);
            }

            angular.forEach(results, function (result) {
                var scriptTag = result[0];
                var fileName = result[1];

                if ($scope.files[fileName]) {
                    var replaceTag = "<script>" + $scope.files[fileName].content;
                    indexhtml = indexhtml.replace(scriptTag, replaceTag);
                }
            });

            doc.open();
            doc.writeln(indexhtml);
            doc.close();
        };
    }
</script>

</body>
</html>